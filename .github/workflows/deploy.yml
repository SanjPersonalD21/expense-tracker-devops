name: Deploy Expense Tracker

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read
  packages: write #Need this for container registry

jobs:
  #1. Test the app code
  test-application:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./application

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
        cache-dependency-path: '**/requirements.txt'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install flake8 pytest

    - name: Lint with flake8
      run: |
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

    - name: Run pytest tests
      run: |
        echo "Running automated tests with pytest.."
        pytest tests/ -v

  #2. Security scan
  security-scan:
    runs-on: ubuntu-latest
    needs: test-application  #Runs only after tests pass
    defaults:
      run:
        working-directory: ./application
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install Bandit
      run: pip install bandit
    
    - name: Run Bandit Security Scan
      run: |
        echo "Running security scan on Python code..."
        #Use the bandit.yml file in application folder
        bandit -r . -c .bandit.yml -f json -o bandit-results.json || echo "Scan completed"
    
    - name: Check for Critical Issues
      run: |
        if [ -f bandit-results.json ]; then
          if grep -q '"issue_severity": "HIGH"' bandit-results.json; then
            echo "Critical: High severity security issues found!"
            echo "Review the bandit-results.json file for details"
            exit 1
          else
            echo "No critical security issues found"
          fi
        else
          echo "Security scan passed"
        fi

  # 3. Build Docker Image (Concept Demonstration)
  build-docker-demo:
    runs-on: ubuntu-latest
    needs: [test-application, security-scan]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Show Docker Concept
      run: |
        echo "DOCKER CONTAINERIZATION DEMONSTRATION"
        echo "========================================"
        echo "Building Docker container to show portable packaging..."
        echo ""
        # Build the image
        docker build -t expense-tracker-demo .
        echo "Docker image built successfully!"
        echo ""
        echo "This demonstrates:"
        echo "1. Containerization principles"
        echo "2. Environment consistency"
        echo "3. Portable deployment artifacts"
        echo ""
        echo "For this demo, we deploy with cloning github methods."
        echo "In production, we'd use AWS ECR + ECS for containers."

  
  #4. Deploy
  deploy:
    runs-on: ubuntu-latest
    needs: build-docker-demo  #Now depends on Docker build
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }} #Github Secrets - Bad practice to hard code secrets
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }} #Github Secrets - Bad practice to hard code secrets
        aws-region: eu-west-3

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3

    - name: Terraform Init
      run: terraform init

    - name: Terraform Plan
      run: terraform plan -no-color -input=false

    - name: Terraform Apply
      if: github.ref == 'refs/heads/main'
      run: terraform apply -auto-approve -input=false